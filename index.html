<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Data</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body { padding: 20px; }

    th {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    th .sort-icon {
      font-size: 12px;
      margin-left: 4px;
      opacity: 0.4;
    }

    th.active .sort-icon {
      opacity: 1;
      font-weight: bold;
    }

    .clickable-row:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="mb-4 text-primary">üìä Rekap Data</h2>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="sheetTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#" onclick="switchSheet('lembar1')">Lembar 1</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" onclick="switchSheet('lembar2')">Lembar 2</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" onclick="switchSheet('lembar3')">Lembar 3</a>
    </li>
  </ul>

  <div class="mb-3">
    <button id="backBtn" onclick="goBack()" class="btn btn-secondary btn-sm d-none">‚¨ÖÔ∏è Kembali</button>
    <input type="text" id="searchBox" placeholder="üîç Cari data..." onkeyup="filterTable()" class="form-control d-none mt-2">
    <button id="exportBtn" onclick="exportExcel()" class="btn btn-success btn-sm d-none mt-2">‚¨áÔ∏è Export Excel</button>
  </div>

  <div class="table-responsive">
    <table id="dataTable" class="table table-bordered table-striped">
      <thead id="tableHead" class="table-dark"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SHEETS = {
  lembar1: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv",
  lembar2: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv",
  lembar3: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"
};

/* ===================== STATE ===================== */
let allData = [];
let currentSheet = "lembar1";
let currentLevel = "petugas";
let currentPetugas = null;
let currentTanggal = null;
let sortState = { index: null, asc: true };

/* ===================== LOAD CSV ===================== */
async function loadCSV(sheet) {
  const res = await fetch(SHEETS[sheet]);
  const csvText = await res.text();

  let parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
  if (parsed.meta.fields.length === 1) {
    parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, delimiter: ";" });
  }

  allData = parsed.data;
  renderPetugas();
}

/* ===================== RENDER LEVEL ===================== */
function renderPetugas() {
  currentLevel = "petugas";
  toggleControls(false, false, false);

  const rekap = {};
  allData.forEach(r => {
    if (!rekap[r.petugas]) rekap[r.petugas] = 0;
    rekap[r.petugas]++;
  });

  renderTableHeader(["Petugas", "Jumlah Data"], 1, true);

  let totalAll = Object.values(rekap).reduce((a,b)=>a+b,0);
  let html = `
    <tr class="clickable-row" onclick="renderTanggal('ALL')">
      <td><b>ALL</b></td>
      <td><b>${totalAll}</b></td>
    </tr>`;

  Object.keys(rekap).forEach(p => {
    html += `
      <tr class="clickable-row" onclick="renderTanggal('${p}')">
        <td>${p}</td>
        <td>${rekap[p]}</td>
      </tr>`;
  });

  tableBody.innerHTML = html;
}

function renderTanggal(petugas) {
  currentLevel = "tanggal";
  currentPetugas = petugas;
  toggleControls(true, false, false);

  let data = petugas === "ALL" ? allData : allData.filter(r => r.petugas === petugas);

  const rekap = {};
  data.forEach(r => {
    if (!rekap[r.tgl_lunas]) rekap[r.tgl_lunas] = 0;
    rekap[r.tgl_lunas]++;
  });

  renderTableHeader(["Tanggal Lunas", "Jumlah Data"], 1, true);

  let html = "";
  Object.keys(rekap).forEach(t => {
    html += `
      <tr class="clickable-row" onclick="renderDetailTanggal('${petugas}','${t}')">
        <td>${t}</td>
        <td>${rekap[t]}</td>
      </tr>`;
  });

  tableBody.innerHTML = html;
}

function renderDetailTanggal(petugas, tanggal) {
  currentLevel = "detail";
  currentTanggal = tanggal;
  toggleControls(true, true, true);

  let data = petugas === "ALL"
    ? allData.filter(r => r.tgl_lunas === tanggal)
    : allData.filter(r => r.petugas === petugas && r.tgl_lunas === tanggal);

  const headers = ["idpel","koked","nama","alamat","tarif","daya","rptag","rpbk","jumlah","petugas","tgl_lunas"];
  renderTableHeader(headers);

  let html = "";
  data.forEach(r => {
    html += "<tr>";
    headers.forEach(h => html += `<td>${r[h] || ""}</td>`);
    html += "</tr>";
  });

  tableBody.innerHTML = html;
}

/* ===================== SORTING ===================== */
function renderTableHeader(headers, defaultIndex=null, defaultDesc=false) {
  sortState = { index: defaultIndex, asc: !defaultDesc };

  let html = "<tr>";
  headers.forEach((h,i)=>{
    html += `<th onclick="sortTableByColumn(${i})">${h}<span class="sort-icon">‚áÖ</span></th>`;
  });
  html += "</tr>";

  tableHead.innerHTML = html;
  if(defaultIndex !== null) sortTableByColumn(defaultIndex, true);
}

function sortTableByColumn(col, force=false) {
  const rows = Array.from(tableBody.querySelectorAll("tr"));
  const headers = document.querySelectorAll("#tableHead th");
  if (!rows.length) return;

  const asc = force ? sortState.asc : sortState.index === col ? !sortState.asc : true;
  sortState = { index: col, asc };

  headers.forEach((h,i)=>{
    h.classList.toggle("active", i===col);
    h.querySelector(".sort-icon").textContent = i===col ? (asc?"‚ñ≤":"‚ñº") : "‚áÖ";
  });

  rows.sort((a,b)=>{
    let A=a.children[col].innerText.trim();
    let B=b.children[col].innerText.trim();

    let nA=parseFloat(A.replace(/[^0-9.-]/g,""));
    let nB=parseFloat(B.replace(/[^0-9.-]/g,""));
    if(!isNaN(nA)&&!isNaN(nB)) return asc?nA-nB:nB-nA;

    let dA=Date.parse(A), dB=Date.parse(B);
    if(!isNaN(dA)&&!isNaN(dB)) return asc?dA-dB:dB-dA;

    return asc?A.localeCompare(B,"id",{numeric:true}):B.localeCompare(A,"id",{numeric:true});
  });

  tableBody.innerHTML="";
  rows.forEach(r=>tableBody.appendChild(r));
}

/* ===================== UTIL ===================== */
function goBack() {
  if(currentLevel==="tanggal") renderPetugas();
  else if(currentLevel==="detail") renderTanggal(currentPetugas);
}

function filterTable() {
  const q = searchBox.value.toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

function exportExcel() {
  const blob = new Blob([dataTable.outerHTML], {type:"application/vnd.ms-excel"});
  saveAs(blob, currentSheet + ".xls");
}

function toggleControls(back, search, exportBtn) {
  backBtn.classList.toggle("d-none", !back);
  searchBox.classList.toggle("d-none", !search);
  exportBtn.classList.toggle("d-none", !exportBtn);
}

function switchSheet(sheet) {
  currentSheet = sheet;
  document.querySelectorAll("#sheetTabs .nav-link").forEach(el=>el.classList.remove("active"));
  document.querySelector(`#sheetTabs .nav-item:nth-child(${sheet==="lembar1"?1:sheet==="lembar2"?2:3}) .nav-link`).classList.add("active");
  loadCSV(sheet);
}

/* ===================== INIT ===================== */
loadCSV("lembar1");
</script>

</body>
</html>
