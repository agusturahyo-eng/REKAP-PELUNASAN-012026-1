<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
.card{border-left:4px solid #0d6efd}
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none" onclick="goBack()">â¬… Kembali</button>
<div id="view"></div>

</div>

<script>
const { jsPDF } = window.jspdf;

/* ================= CONFIG ================= */
const SHEETS={
 lembar1:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
 lembar2:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
 lembar3:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

/* ================= STATE ================= */
let allData=[], current=[], history=[];

/* ================= UTIL ================= */
const isLunas=r=>r.tgl_lunas && r.tgl_lunas!="-";

/* ================= NAV ================= */
function push(fn){ history.push(fn); backBtn.classList.remove("d-none"); }
function goBack(){
 history.pop();
 if(history.length) history[history.length-1]();
 else{ backBtn.classList.add("d-none"); renderPetugas(); }
}

/* ================= LOAD ================= */
function loadSheet(k){
 history=[]; backBtn.classList.add("d-none");
 fetch(SHEETS[k].url).then(r=>r.text()).then(csv=>{
  allData=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
  renderPetugas();
 });
}

/* ================= REKAP ================= */
function renderPetugas(){
 const map={};
 allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);

 let h=`<table class="table table-bordered">
 <thead class="table-dark"><tr><th>Petugas</th><th>Jumlah</th></tr></thead><tbody>
 <tr class="table-primary clickable" onclick="openList(allData,'SEMUA PETUGAS')">
 <td><b>SEMUA PETUGAS</b></td><td><b>${allData.length}</b></td></tr>`;

 Object.keys(map).forEach(p=>{
  h+=`<tr class="clickable" onclick="openList(allData.filter(r=>r.petugas=='${p}'),'${p}')">
  <td>${p}</td><td>${map[p]}</td></tr>`;
 });
 h+=`</tbody></table>`;
 view.innerHTML=h;
}

/* ================= LIST ================= */
function openList(data,title){
 push(renderPetugas);
 current=data;
 let h=`<h6 class="text-primary">${title}</h6>
 <table class="table table-sm table-bordered">
 <thead class="table-success">
 <tr><th>IDPEL</th><th>Koded</th><th>Nama</th><th>Tarif/Daya</th><th>Rp</th></tr>
 </thead><tbody>`;

 data.forEach(r=>{
  h+=`<tr class="clickable" onclick='openCard(${JSON.stringify(r)})'>
  <td>${r.idpel}</td>
  <td>${r.koked}</td>
  <td>${r.nama}</td>
  <td>${r.tarif}/${r.daya}</td>
  <td class="text-end">${(+r.jumlah||0).toLocaleString("id-ID")}</td>
  </tr>`;
 });
 h+=`</tbody></table>`;
 view.innerHTML=h;
}

/* ================= CARD ================= */
function openCard(r){
 push(()=>openList(current,"Kembali"));
 let h=`<div class="card mb-3"><div class="card-body">
 <b>${r.nama}</b><br>
 IDPEL: ${r.idpel}<br>
 Koded: ${r.koked}<br>
 Alamat: ${r.alamat}<br>
 Tarif/Daya: ${r.tarif}/${r.daya}<br>
 <b>Rp ${(+r.jumlah||0).toLocaleString("id-ID")}</b>
 <div class="mt-3">
 <button class="btn btn-success btn-sm" onclick='kirimSurat(${JSON.stringify(r)})'>
 ðŸ“„ + ðŸ“¤ Kirim WA
 </button>
 </div></div></div>`;
 view.innerHTML=h;
}

/* ================= PDF + WA ================= */
function kirimSurat(r){
 const pdf=new jsPDF({format:"a5",unit:"mm"});
 pdf.setFontSize(9);

 pdf.text("PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY",10,10);
 pdf.text("UP3 KLATEN - ULP TULUNG",10,15);
 pdf.text("PEMBERITAHUAN PEMUTUSAN SEMENTARA",105,25,{align:"center"});

 let y=40;
 const t=(l,v)=>{pdf.text(l,10,y);pdf.text(": "+(v||""),45,y);y+=6};
 t("Nama",r.nama);
 t("IDPEL",r.idpel);
 t("Koded",r.koked);
 t("Alamat",r.alamat);
 t("Tarif/Daya",`${r.tarif}/${r.daya}`);
 t("Jumlah",`Rp ${(+r.jumlah||0).toLocaleString("id-ID")}`);

 pdf.text("TULUNG,",120,120);
 pdf.text("MANAGER",130,130);

 const fname=`${r.idpel}_${r.nama}`.replace(/[^a-z0-9_-]/gi,"_")+".pdf";
 pdf.save(fname);

 const wa=encodeURIComponent(
`PT. PLN (PERSERO)
UP3 KLATEN - ULP TULUNG

Nama: ${r.nama}
IDPEL: ${r.idpel}
Jumlah Tunggakan:
Rp ${(+r.jumlah||0).toLocaleString("id-ID")}`
 );
 window.open("https://wa.me/?text="+wa,"_blank");
}

/* START */
loadSheet("lembar1");
</script>
</body>
</html>






