<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
<div id="view"></div>

</div>

<script>
/* ================= CONFIG ================= */
const SHEETS={
 lembar1:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
 lembar2:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
 lembar3:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

let allData=[], currentDetail=[], currentPetugas="";
let viewStack=[];

const backBtn=document.getElementById("backBtn");
const view=document.getElementById("view");
const isLunas=r=>r.tgl_lunas && r.tgl_lunas.trim()!=="" && r.tgl_lunas!="-";

/* ================= NAV ================= */
function pushView(fn){
 viewStack.push(fn);
 backBtn.classList.remove("d-none");
}
backBtn.onclick=()=>{
 viewStack.pop();
 if(viewStack.length){
   viewStack[viewStack.length-1]();
 }else{
   backBtn.classList.add("d-none");
   renderPetugas();
 }
};

/* ================= LOAD ================= */
function loadSheet(k){
 viewStack=[];
 backBtn.classList.add("d-none");
 fetch(SHEETS[k].url).then(r=>r.text()).then(csv=>{
   allData=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
   renderPetugas();
 });
}

/* ================= TEMPLATE SURAT ================= */
function templateSurat(r){
return `
PT. PLN (PERSERO)
UP3 KLATEN
ULP TULUNG

PEMBERITAHUAN PEMUTUSAN SEMENTARA

Nama  : ${r.nama}
IDPEL : ${r.idpel}
Alamat: ${r.alamat}
Tarif/Daya: ${r.tarif}/${r.daya}
Koded : ${r.koked}

Jumlah Tunggakan:
Rp ${Number(r.jumlah).toLocaleString("id-ID")}

Mohon segera dilakukan pembayaran.
Abaikan pesan ini jika sudah membayar.

PLN ULP TULUNG
`;
}

/* ================= REKAP PETUGAS ================= */
function renderPetugas(){
 viewStack=[];
 backBtn.classList.add("d-none");

 const map={};
 allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);

 let h=`<table class="table table-bordered">
 <thead class="table-dark"><tr><th>Petugas</th><th>Jumlah</th></tr></thead><tbody>
 <tr class="table-primary clickable" onclick="openGlobal()">
 <td><b>SEMUA PETUGAS</b></td><td><b>${allData.length}</b></td></tr>`;

 Object.keys(map).forEach(p=>{
  h+=`<tr class="clickable" onclick="openPetugas('${p}')">
  <td>${p}</td><td>${map[p]}</td></tr>`;
 });

 h+=`</tbody></table>`;
 view.innerHTML=h;
}

/* ================= GLOBAL ================= */
function openGlobal(){
 pushView(renderPetugas);
 currentPetugas="SEMUA";
 const lunas=allData.filter(isLunas);
 const byDate={};
 lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

 let h=`<h6 class="text-primary">Rekap Semua Petugas</h6>
 <table class="table table-sm table-bordered">
 <thead class="table-success"><tr><th>Tanggal</th><th>Jumlah</th></tr></thead><tbody>`;

 Object.keys(byDate).forEach(t=>{
  h+=`<tr class="clickable" onclick="detailGlobalLunas('${t}')">
  <td>${t}</td><td>${byDate[t]}</td></tr>`;
 });
 h+=`</tbody></table>
 <h6 class="clickable" onclick="detailGlobalBelum()">Belum Lunas</h6>`;
 view.innerHTML=h;
}

/* ================= PETUGAS ================= */
function openPetugas(p){
 pushView(renderPetugas);
 currentPetugas=p;

 const data=allData.filter(r=>r.petugas===p);
 const lunas=data.filter(isLunas);
 const byDate={};
 lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

 let h=`<h6 class="text-primary">Petugas: ${p}</h6>
 <table class="table table-sm table-bordered">
 <thead class="table-success"><tr><th>Tanggal</th><th>Jumlah</th></tr></thead><tbody>`;

 Object.keys(byDate).forEach(t=>{
  h+=`<tr class="clickable" onclick="detailLunas('${t}')">
  <td>${t}</td><td>${byDate[t]}</td></tr>`;
 });
 h+=`</tbody></table>
 <h6 class="clickable" onclick="detailBelum()">Belum Lunas</h6>`;
 view.innerHTML=h;
}

/* ================= DETAIL ================= */
function detailLunas(t){
 pushView(()=>openPetugas(currentPetugas));
 currentDetail=allData.filter(r=>r.petugas===currentPetugas && isLunas(r)&&r.tgl_lunas===t);
 renderDetailTable(`Detail Lunas ${t}`);
}
function detailBelum(){
 pushView(()=>openPetugas(currentPetugas));
 currentDetail=allData.filter(r=>r.petugas===currentPetugas&&!isLunas(r));
 renderDetailTable("Detail Belum Lunas");
}
function detailGlobalLunas(t){
 pushView(openGlobal);
 currentDetail=allData.filter(r=>isLunas(r)&&r.tgl_lunas===t);
 renderDetailTable(`Detail Lunas ${t}`);
}
function detailGlobalBelum(){
 pushView(openGlobal);
 currentDetail=allData.filter(r=>!isLunas(r));
 renderDetailTable("Detail Belum Lunas");
}

/* ================= TABLE ================= */
function renderDetailTable(title){
 let h=`<h6>${title}</h6>
 <button class="btn btn-success btn-sm mb-2" onclick="exportExcel()">â¬‡ Export Excel</button>
 <table class="table table-sm table-bordered"><thead>
 <tr><th>IDPEL</th><th>Nama</th><th>Alamat</th><th>Rp</th></tr>
 </thead><tbody>`;

 currentDetail.forEach(r=>{
  h+=`<tr class="clickable" onclick="showCards()">
  <td>${r.idpel}</td><td>${r.nama}</td>
  <td>${r.alamat}</td>
  <td class="text-end">${Number(r.jumlah).toLocaleString("id-ID")}</td></tr>`;
 });
 h+=`</tbody></table>`;
 view.innerHTML=h;
}

/* ================= CARD ================= */
function showCards(){
 pushView(()=>renderDetailTable("Detail"));
 let h=`<h6 class="text-primary">Detail Pelanggan</h6>`;
 currentDetail.forEach(r=>{
  let msg=encodeURIComponent(templateSurat(r));
  h+=`<div class="card mb-2"><div class="card-body p-2">
  <b>${r.nama}</b><br>IDPEL: ${r.idpel}<br>${r.alamat}<br>
  <b>Rp ${Number(r.jumlah).toLocaleString("id-ID")}</b><br>
  <a class="btn btn-success btn-sm mt-2" target="_blank"
  href="https://wa.me/?text=${msg}">ðŸ“¤ Kirim via WhatsApp</a>
  </div></div>`;
 });
 view.innerHTML=h;
}

/* ================= EXCEL ================= */
function exportExcel(){
 let t="<table><tr><th>IDPEL</th><th>Nama</th><th>Alamat</th><th>Jumlah</th></tr>";
 currentDetail.forEach(r=>{
  t+=`<tr><td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td><td>${r.jumlah}</td></tr>`;
 });
 t+="</table>";
 saveAs(new Blob([t],{type:"application/vnd.ms-excel"}),"detail.xls");
}

loadSheet("lembar1");
</script>
</body>
</html>








