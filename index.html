<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { background:#f4f6f9; }
.clickable { cursor:pointer; }
</style>
</head>

<body>
<div class="container my-3">

<h4 class="text-center text-primary mb-3">
ðŸ“Š Rekap Tunggakan ULP Tulung
</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none" onclick="goBack()">â¬… Kembali</button>

<div id="tableArea"></div>

</div>

<script>
/* ================= CONFIG ================= */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?output=csv";

/* ================= STATE ================= */
let allData = [];
let currentPetugas = null;
let lastViewFn = null;
let lastTableData = [];

/* ================= UTIL ================= */
function isLunas(r){
  return r.tgl_lunas && r.tgl_lunas.trim() !== "" && r.tgl_lunas !== "-";
}

/* ================= LOAD ================= */
fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{
  allData = Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
  renderRekapPetugas();
});

/* ================= VIEW ================= */
function renderRekapPetugas(){
  lastViewFn=null;
  backBtn.classList.add("d-none");

  const map={};
  allData.forEach(r=>{
    map[r.petugas]=(map[r.petugas]||0)+1;
  });

  let html=`<table class="table table-bordered">
  <thead class="table-dark"><tr><th>Petugas</th><th>Jumlah</th></tr></thead><tbody>`;
  Object.keys(map).forEach(p=>{
    html+=`<tr class="clickable" onclick="renderPetugas('${p}')">
    <td>${p}</td><td>${map[p]}</td></tr>`;
  });
  html+="</tbody></table>";
  tableArea.innerHTML=html;
}

function renderPetugas(p){
  currentPetugas=p;
  lastViewFn=()=>renderPetugas(p);
  backBtn.classList.remove("d-none");

  const data=allData.filter(r=>r.petugas===p);
  const lunas=data.filter(isLunas);
  const belum=data.filter(r=>!isLunas(r));

  let html=`<h6 class="text-primary">Petugas: ${p}</h6>`;

  /* LUNAS */
  const byDate={};
  lunas.forEach(r=>{
    byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1;
  });

  html+=`<h6 class="text-success mt-3">Lunas per Tanggal</h6>
  <table class="table table-sm table-bordered">
  <thead class="table-success"><tr><th>Tanggal</th><th>Jumlah</th></tr></thead><tbody>`;
  Object.keys(byDate).forEach(t=>{
    html+=`<tr class="clickable" onclick="detailLunas('${t}')">
    <td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  html+="</tbody></table>";

  /* BELUM */
  html+=`<h6 class="text-danger mt-3">Belum Lunas</h6>
  <button class="btn btn-danger btn-sm" onclick="detailBelum()">Lihat Detail</button>`;

  tableArea.innerHTML=html;
}

function detailLunas(tgl){
  lastTableData=allData.filter(r=>r.petugas===currentPetugas && isLunas(r) && r.tgl_lunas===tgl);
  lastViewFn=()=>detailLunas(tgl);
  renderDetailTable(`Detail Lunas ${tgl}`,"success");
}

function detailBelum(){
  lastTableData=allData.filter(r=>r.petugas===currentPetugas && !isLunas(r));
  lastViewFn=detailBelum;
  renderDetailTable("Detail Belum Lunas","danger");
}

function renderDetailTable(title,color){
  let html=`<h6 class="text-${color}">${title}</h6>
  <div class="table-responsive">
  <table class="table table-sm table-bordered">
  <thead class="table-${color}">
  <tr><th>IDPEL</th><th>Nama</th><th>Alamat</th><th>Koded</th><th>Tarif/Daya</th><th>Rp</th></tr>
  </thead><tbody>`;
  lastTableData.forEach(r=>{
    html+=`<tr>
    <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
    <td>${r.koked}</td><td>${r.tarif}/${r.daya}</td>
    <td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td>
    </tr>`;
  });
  html+=`</tbody></table></div>

  <button class="btn btn-primary w-100 mt-2" onclick="showCards()">
  ðŸ“‹ Tampilkan Card View
  </button>`;

  tableArea.innerHTML=html;
}

function showCards(){
  let html=`<h6 class="mt-3">Card View</h6>`;
  lastTableData.forEach(r=>{
    html+=`<div class="card mb-2">
    <div class="card-body p-2">
    <b>${r.nama}</b><br>
    IDPEL: ${r.idpel}<br>
    ${r.alamat}<br>
    Koded: ${r.koked}<br>
    Tarif/Daya: ${r.tarif}/${r.daya}<br>
    Rp ${(+r.jumlah).toLocaleString("id-ID")}
    </div></div>`;
  });
  tableArea.innerHTML+=html;
}

function goBack(){
  if(lastViewFn) lastViewFn();
  else renderRekapPetugas();
}
</script>
</body>
</html>









