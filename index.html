<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
<div id="view"></div>

</div>

<script>
const SHEETS={
  lembar1:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

let allData=[], currentPetugas=null, currentDetail=[], currentTitle="";
let history=[];

const isLunas=r=>r.tgl_lunas && r.tgl_lunas.trim()!=="" && r.tgl_lunas!="-";

function loadSheet(key){
  history=[];
  backBtn.classList.add("d-none");
  document.querySelectorAll(".nav-link").forEach(t=>t.classList.remove("active"));
  document.getElementById("tab-"+key).classList.add("active");

  fetch(SHEETS[key].url).then(r=>r.text()).then(csv=>{
    allData=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
    renderPetugas();
  });
}

function pushView(fn){
  history.push(fn);
  backBtn.classList.remove("d-none");
}
backBtn.onclick=()=>{
  history.pop();
  if(history.length) history.at(-1)();
  else{ backBtn.classList.add("d-none"); renderPetugas(); }
};

function renderPetugas(){
  history=[];
  backBtn.classList.add("d-none");
  const map={};
  allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);

  let h=`<table class="table table-bordered">
  <thead class="table-dark"><tr><th>Petugas</th><th>Jumlah</th></tr></thead><tbody>
  <tr class="table-primary clickable" onclick="openGlobal()">
  <td><b>SEMUA PETUGAS</b></td><td><b>${allData.length}</b></td></tr>`;

  Object.keys(map).forEach(p=>{
    h+=`<tr class="clickable" onclick="openPetugas('${p}')"><td>${p}</td><td>${map[p]}</td></tr>`;
  });
  h+=`</tbody></table>`;
  view.innerHTML=h;
}

function openGlobal(){
  pushView(renderPetugas);
  const lunas=allData.filter(isLunas);
  const byDate={};
  lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

  let h=`<h6 class="text-primary">Rekap Semua Petugas</h6>
  <table class="table table-sm table-bordered mt-2">
  <thead class="table-success"><tr><th>Tanggal</th><th>Jumlah</th></tr></thead><tbody>`;

  Object.keys(byDate).forEach(t=>{
    h+=`<tr class="clickable" onclick="detailGlobalLunas('${t}')"><td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  h+=`</tbody></table>`;
  view.innerHTML=h;
}

function openPetugas(p){
  pushView(renderPetugas);
  currentPetugas=p;
  const data=allData.filter(r=>r.petugas===p && isLunas(r));
  const byDate={};
  data.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

  let h=`<h6 class="text-primary">Petugas: ${p}</h6>
  <table class="table table-sm table-bordered mt-2">
  <thead class="table-success"><tr><th>Tanggal</th><th>Jumlah</th></tr></thead><tbody>`;

  Object.keys(byDate).forEach(t=>{
    h+=`<tr class="clickable" onclick="detailLunas('${t}')"><td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  h+=`</tbody></table>`;
  view.innerHTML=h;
}

function detailLunas(t){
  pushView(()=>openPetugas(currentPetugas));
  currentTitle=`Lunas_${t}`;
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && isLunas(r) && r.tgl_lunas===t);
  renderDetailTable(`Detail Lunas ${t}`);
}
function detailGlobalLunas(t){
  pushView(openGlobal);
  currentTitle=`Global_Lunas_${t}`;
  currentDetail=allData.filter(r=>isLunas(r)&&r.tgl_lunas===t);
  renderDetailTable(`Detail Lunas ${t}`);
}

function renderDetailTable(title){
  let h=`<h6 class="text-success">${title}</h6>
  <div class="table-responsive mt-2">
  <table class="table table-sm table-bordered">
  <thead class="table-success">
  <tr>
    <th>IDPEL</th><th>Koded</th><th>Nama</th><th>Alamat</th>
    <th>Tarif/Daya</th><th>Rp</th>
  </tr></thead><tbody>`;

  currentDetail.forEach(r=>{
    h+=`<tr class="clickable" onclick="showCards()">
      <td>${r.idpel}</td>
      <td>${r.koked||"-"}</td>
      <td>${r.nama}</td>
      <td>${r.alamat}</td>
      <td>${r.tarif}/${r.daya}</td>
      <td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td>
    </tr>`;
  });
  h+=`</tbody></table></div>`;
  view.innerHTML=h;
}

function showCards(){
  pushView(()=>renderDetailTable(currentTitle));
  let h=`<h6 class="text-primary">Detail Pelanggan</h6>`;
  currentDetail.forEach(r=>{
    h+=`<div class="card mb-2"><div class="card-body p-2">
      <b>${r.nama}</b><br>
      IDPEL : <b>${r.idpel}</b><br>
      Koded : <b>${r.koked||"-"}</b><br>
      Tarif/Daya : ${r.tarif}/${r.daya}<br>
      ${r.alamat}<br>
      <b>Rp ${(+r.jumlah).toLocaleString("id-ID")}</b>
      <div class="mt-2">
        <a class="btn btn-success btn-sm" target="_blank"
           href="https://wa.me/${r.no_hp||""}?text=${encodeURIComponent('IDPEL '+r.idpel)}">
           ðŸ“¤ Kirim via WhatsApp
        </a>
      </div>
    </div></div>`;
  });
  view.innerHTML=h;
}

loadSheet("lembar1");
</script>
</body>
</html>




