<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rekap Data</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{padding:20px;background:#f6f7f9}
th{cursor:pointer}
.clickable-row:hover{background:#eef}

/* ===== MOBILE CARD MODE ===== */
@media(max-width:768px){
  table thead{display:none}
  table,tbody,tr,td{display:block;width:100%}
  tr{
    background:#fff;
    margin-bottom:12px;
    border-radius:10px;
    padding:10px;
    box-shadow:0 2px 6px rgba(0,0,0,.1)
  }
  td{border:none;padding:4px 0}
  td::before{
    content:attr(data-label);
    font-weight:600;
    display:block;
    color:#666;
    font-size:12px
  }
}

/* SORT MOBILE HANYA ANDROID */
#mobileSort{display:none}
@media(max-width:768px){
  #mobileSort{display:block}
}
</style>
</head>

<body>
<div class="container">

<h3 class="text-primary mb-3">ðŸ“Š Rekap Data</h3>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" onclick="switchSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" onclick="switchSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" onclick="switchSheet('lembar3')">Lembar 3</a></li>
</ul>

<div class="mb-2">
  <button id="backBtn" class="btn btn-secondary btn-sm d-none" onclick="goBack()">â¬… Kembali</button>
  <input id="searchBox" class="form-control mt-2 d-none" placeholder="ðŸ” Cari..." onkeyup="filterTable()">

  <!-- SORT ANDROID -->
  <select id="mobileSort" class="form-select mt-2 d-none" onchange="mobileSortChange()">
    <option value="">â†• Urutkan Data</option>
    <option value="idpel">ID Pelanggan</option>
    <option value="nama">Nama</option>
    <option value="tarif">Tarif</option>
    <option value="daya">Daya</option>
    <option value="jumlah">Jumlah</option>
    <option value="tgl_lunas">Tanggal Lunas</option>
  </select>

  <button id="exportBtn" class="btn btn-success btn-sm mt-2 d-none" onclick="exportExcel()">â¬‡ Export Excel</button>
</div>

<div class="table-responsive">
<table id="dataTable" class="table table-bordered table-striped">
  <thead id="tableHead" class="table-dark"></thead>
  <tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script>
const SHEETS={
 lembar1:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv",
 lembar2:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv",
 lembar3:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"
};

let allData=[],currentSheet="lembar1";
let level="petugas",petugasAktif=null,tglAktif=null;
let sortCol=null,sortAsc=true;

async function loadCSV(sheet){
 const r=await fetch(SHEETS[sheet]);
 const t=await r.text();
 allData=Papa.parse(t,{header:true,skipEmptyLines:true}).data;
 renderPetugas();
}

function renderPetugas(){
 level="petugas";
 toggle(false,false,false);
 const map={};
 allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);
 renderHeader(["Petugas","Jumlah"]);
 let html=`<tr class="clickable-row" onclick="renderTanggal('ALL')">
 <td data-label="Petugas"><b>ALL</b></td>
 <td data-label="Jumlah"><b>${Object.values(map).reduce((a,b)=>a+b,0)}</b></td></tr>`;
 Object.keys(map).forEach(p=>{
  html+=`<tr class="clickable-row" onclick="renderTanggal('${p}')">
  <td data-label="Petugas">${p}</td>
  <td data-label="Jumlah">${map[p]}</td></tr>`;
 });
 body(html);
}

function renderTanggal(p){
 level="tanggal";petugasAktif=p;
 toggle(true,false,false);
 let d=p==="ALL"?allData:allData.filter(r=>r.petugas===p);
 const map={};
 d.forEach(r=>map[r.tgl_lunas]=(map[r.tgl_lunas]||0)+1);
 renderHeader(["Tanggal","Jumlah"]);
 let html="";
 Object.keys(map).forEach(t=>{
  html+=`<tr class="clickable-row" onclick="renderDetail('${p}','${t}')">
  <td data-label="Tanggal">${t}</td>
  <td data-label="Jumlah">${map[t]}</td></tr>`;
 });
 body(html);
}

function renderDetail(p,t){
 level="detail";tglAktif=t;
 toggle(true,true,true);

 let d=allData.filter(r=>(p==="ALL"||r.petugas===p)&&r.tgl_lunas===t);

 if(sortCol){
  d.sort((a,b)=>{
   let x=a[sortCol]||"",y=b[sortCol]||"";
   return sortAsc
    ? x.localeCompare(y,undefined,{numeric:true})
    : y.localeCompare(x,undefined,{numeric:true});
  });
 }

 const h=["idpel","koked","nama","alamat","tarif","daya","rptag","rpbk","jumlah","petugas","tgl_lunas"];
 renderHeader(h,true);

 let html="";
 d.forEach(r=>{
  html+="<tr>";
  h.forEach(c=>html+=`<td data-label="${c.toUpperCase()}">${r[c]||""}</td>`);
  html+="</tr>";
 });
 body(html);
}

function renderHeader(h,sortable=false){
 let html="<tr>";
 h.forEach(c=>{
  html+=sortable?`<th onclick="sortBy('${c}')">${c}</th>`:`<th>${c}</th>`;
 });
 html+="</tr>";
 tableHead.innerHTML=html;
}

function sortBy(c){
 sortAsc = sortCol===c ? !sortAsc : true;
 sortCol=c;
 renderDetail(petugasAktif,tglAktif);
}

function mobileSortChange(){
 if(!mobileSort.value)return;
 sortCol=mobileSort.value;
 sortAsc=true;
 renderDetail(petugasAktif,tglAktif);
 window.scrollTo({top:0,behavior:"smooth"});
}

function body(h){tableBody.innerHTML=h}

function toggle(back,search,exportBtn){
 backBtn.classList.toggle("d-none",!back);
 searchBox.classList.toggle("d-none",!search);
 exportBtn.classList.toggle("d-none",!exportBtn);

 /* SORT MOBILE MUNCUL SAAT DETAIL */
 mobileSort.classList.toggle("d-none",!exportBtn);
}

function goBack(){
 level==="detail" ? renderTanggal(petugasAktif) : renderPetugas();
}

function filterTable(){
 const q=searchBox.value.toLowerCase();
 document.querySelectorAll("#tableBody tr").forEach(r=>{
  r.style.display=r.innerText.toLowerCase().includes(q)?"":"none";
 });
}

function exportExcel(){
 const blob=new Blob([dataTable.outerHTML],{type:"application/vnd.ms-excel"});
 saveAs(blob,currentSheet+".xls");
}

function switchSheet(s){
 currentSheet=s;
 document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active"));
 event.target.classList.add("active");
 loadCSV(s);
}

loadCSV("lembar1");
</script>
</body>
</html>
