<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
</style>
</head>

<body>
<div class="container my-3">

<!-- TAB PER LEMBAR -->
<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a>
  </li>
</ul>

<h4 class="text-center text-primary mb-3">
âš¡ Rekap Tunggakan ULP Tulung
</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
<div id="view"></div>

</div>

<script>
/* ================= CONFIG ================= */
const SHEETS = {
  lembar1:{ url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv" },
  lembar2:{ url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv" },
  lembar3:{ url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv" }
};

/* ================= STATE ================= */
let allData=[], currentPetugas=null, currentDetail=[], currentTitle="";
let history=[], currentSheet="lembar1";

/* ================= UTIL ================= */
const isLunas=r=>r.tgl_lunas && r.tgl_lunas.trim()!=="" && r.tgl_lunas!="-";

/* ================= LOAD ================= */
function loadSheet(key){
  currentSheet=key;
  history=[];
  backBtn.classList.add("d-none");

  document.querySelectorAll(".nav-link").forEach(t=>t.classList.remove("active"));
  document.getElementById("tab-"+key).classList.add("active");

  fetch(SHEETS[key].url)
    .then(r=>r.text())
    .then(csv=>{
      allData = Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
      renderPetugas();
    });
}

/* ================= HISTORY ================= */
function pushView(fn){
  history.push(fn);
  backBtn.classList.remove("d-none");
}
backBtn.onclick=()=>{
  history.pop();
  if(history.length){
    history[history.length-1]();
  }else{
    backBtn.classList.add("d-none");
    renderPetugas();
  }
};

/* ================= WA MESSAGE ================= */
function waMessage(r){
  return encodeURIComponent(`
PT. PLN (PERSERO)
UP3 KLATEN
ULP TULUNG

PEMBERITAHUAN PEMUTUSAN SEMENTARA

Nama : ${r.nama}
IDPEL : ${r.idpel}
Alamat : ${r.alamat}
Tarif/Daya : ${r.tarif}/${r.daya}
Koded : ${r.koked}

Jumlah Tunggakan :
Rp ${(+r.jumlah).toLocaleString("id-ID")}
(Belum Termasuk Admin Bank)

Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas   
terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan.
Penyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi
di tempat penerimaan pembayaran rekening listrik, kantor pos, atau bank yang ditunjuk oleh PLN.                       
   Apabila dalam jangka waktu 60 hari terhitung sejak dilakukan pemutusan sementara tunggakan belum dilunasi,         
maka instalasi milik PLN akan dibongkar, dan penyambungan kembali dapat dilaksanakan setelah Saudara menyelesaikan    
Biaya Penyambungan yang diperlakukan sebagai sambungan baru serta tetap diwajibkan membayar tagihan listrik           
yang belum dilunasi beserta dendanya

Tulung, 21 Januari 2026
PLN ULP TULUNG
`);
}

/* ================= REKAP PETUGAS ================= */
function renderPetugas(){
  history=[];
  backBtn.classList.add("d-none");

  const map={};
  allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);

  let h=`<table class="table table-bordered">
  <thead class="table-dark">
  <tr><th>Petugas</th><th>Jumlah</th></tr>
  </thead><tbody>`;

  h+=`<tr class="table-primary clickable" onclick="openGlobal()">
  <td><b>SEMUA PETUGAS</b></td>
  <td><b>${allData.length}</b></td>
  </tr>`;

  Object.keys(map).forEach(p=>{
    h+=`<tr class="clickable" onclick="openPetugas('${p}')">
    <td>${p}</td><td>${map[p]}</td></tr>`;
  });

  h+=`</tbody></table>`;
  view.innerHTML=h;
}

/* ================= GLOBAL ================= */
function openGlobal(){
  pushView(renderPetugas);
  currentPetugas="SEMUA";

  const lunas=allData.filter(isLunas);
  const belum=allData.filter(r=>!isLunas(r));

  const byDate={};
  lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

  let h=`<h6 class="text-primary">Rekap Semua Petugas</h6>
  <h6 class="text-success mt-3">Lunas per Tanggal</h6>
  <table class="table table-sm table-bordered">
  <thead class="table-success">
  <tr><th>Tanggal</th><th>Jumlah</th></tr>
  </thead><tbody>`;

  Object.keys(byDate).forEach(t=>{
    h+=`<tr class="clickable" onclick="detailGlobalLunas('${t}')">
    <td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  h+=`</tbody></table>`;

  if(belum.length>0){
    h+=`<h6 class="mt-3 clickable" onclick="detailGlobalBelum()">Belum Lunas</h6>`;
  }

  view.innerHTML=h;
}

/* ================= PETUGAS ================= */
function openPetugas(p){
  pushView(renderPetugas);
  currentPetugas=p;

  const data=allData.filter(r=>r.petugas===p);
  const lunas=data.filter(isLunas);
  const belum=data.filter(r=>!isLunas(r));

  const byDate={};
  lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

  let h=`<h6 class="text-primary">Petugas: ${p}</h6>
  <h6 class="text-success mt-3">Lunas per Tanggal</h6>
  <table class="table table-sm table-bordered">
  <thead class="table-success">
  <tr><th>Tanggal</th><th>Jumlah</th></tr>
  </thead><tbody>`;

  Object.keys(byDate).forEach(t=>{
    h+=`<tr class="clickable" onclick="detailLunas('${t}')">
    <td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  h+=`</tbody></table>`;

  if(belum.length>0){
    h+=`<h6 class="mt-3 clickable" onclick="detailBelum()">Belum Lunas</h6>`;
  }

  view.innerHTML=h;
}

/* ================= DETAIL ================= */
function detailLunas(t){
  pushView(()=>openPetugas(currentPetugas));
  currentTitle=`Lunas_${t}`;
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && isLunas(r) && r.tgl_lunas===t);
  renderDetailTable(`Detail Lunas ${t}`,"success");
}
function detailBelum(){
  pushView(()=>openPetugas(currentPetugas));
  currentTitle="Belum_Lunas";
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && !isLunas(r));
  renderDetailTable("Detail Belum Lunas","secondary");
}
function detailGlobalLunas(t){
  pushView(openGlobal);
  currentTitle=`Global_Lunas_${t}`;
  currentDetail=allData.filter(r=>isLunas(r)&&r.tgl_lunas===t);
  renderDetailTable(`Detail Lunas ${t}`,"success");
}
function detailGlobalBelum(){
  pushView(openGlobal);
  currentTitle="Global_Belum_Lunas";
  currentDetail=allData.filter(r=>!isLunas(r));
  renderDetailTable("Detail Belum Lunas","secondary");
}

/* ================= TABLE + CARD ================= */
function renderDetailTable(title,color){
  let h=`<div class="d-flex justify-content-between">
  <h6 class="text-${color}">${title}</h6>
  <button class="btn btn-success btn-sm" onclick="exportExcel()">â¬‡ Export Excel</button>
  </div>

  <div class="table-responsive mt-2">
  <table class="table table-sm table-bordered">
  <thead class="table-${color}">
  <tr>
  <th>IDPEL</th><th>Nama</th><th>Alamat</th>
  <th>Koded</th><th>Tarif</th><th>Daya</th><th>Rp</th>
  </tr></thead><tbody>`;

  currentDetail.forEach(r=>{
    h+=`<tr class="clickable" onclick="showCards()">
    <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
    <td>${r.koked}</td><td>${r.tarif}</td><td>${r.daya}</td>
    <td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td>
    </tr>`;
  });

  h+=`</tbody></table></div>`;
  view.innerHTML=h;
}

function showCards(){
  pushView(()=>renderDetailTable(currentTitle,"secondary"));

  let h=`<h6 class="text-primary">Detail Pelanggan</h6>`;
  currentDetail.forEach(r=>{
    h+=`<div class="card mb-2">
      <div class="card-body p-2">
        <b>${r.nama}</b><br>
        IDPEL: ${r.idpel}<br>
        ${r.alamat}<br>
        Koded: ${r.koked}<br>
        Tarif/Daya: ${r.tarif}/${r.daya}<br>
        <b>Rp ${(+r.jumlah).toLocaleString("id-ID")}</b>
        <div class="mt-2">
          <a class="btn btn-success btn-sm"
             target="_blank"
             href="https://wa.me/${r.no_hp || ""}?text=${waMessage(r)}">
             ðŸ“¤ Kirim via WhatsApp
          </a>
        </div>
      </div>
    </div>`;
  });
  view.innerHTML=h;
}

function exportExcel(){
  let table=`<table><tr>
  <th>IDPEL</th><th>Nama</th><th>Alamat</th>
  <th>Koded</th><th>Tarif</th><th>Daya</th><th>Jumlah</th>
  </tr>`;
  currentDetail.forEach(r=>{
    table+=`<tr>
    <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
    <td>${r.koked}</td><td>${r.tarif}</td><td>${r.daya}</td>
    <td>${r.jumlah}</td></tr>`;
  });
  table+=`</table>`;
  saveAs(new Blob([table],{type:"application/vnd.ms-excel"}),`${currentTitle}.xls`);
}

/* LOAD AWAL */
loadSheet("lembar1");
</script>
</body>
</html>




