<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
</style>
</head>

<body>
<div class="container my-3">

<h4 class="text-center text-primary mb-3">
⚡ Rekap Tunggakan ULP Tulung
</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">⬅ Kembali</button>

<div id="view"></div>

</div>

<script>
/* ================= CONFIG ================= */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?output=csv";

/* ================= STATE ================= */
let allData=[], currentPetugas=null, currentDetail=[], currentTitle="";
let history=[];

/* ================= UTIL ================= */
const isLunas=r=>r.tgl_lunas && r.tgl_lunas.trim()!=="" && r.tgl_lunas!="-";

/* ================= LOAD ================= */
fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{
  allData=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
  renderPetugas();
});

/* ================= HISTORY ================= */
function pushView(fn){
  history.push(fn);
  backBtn.classList.remove("d-none");
}
backBtn.onclick=()=>{
  history.pop();
  if(history.length){
    history[history.length-1]();
  }else{
    backBtn.classList.add("d-none");
    renderPetugas();
  }
};

/* ================= VIEW ================= */
function renderPetugas(){
  history=[];
  backBtn.classList.add("d-none");

  /* ===== REKAP GLOBAL ===== */
  const total = allData.length;
  const lunas = allData.filter(isLunas).length;
  const belum = total - lunas;

  let h=`
  <div class="card mb-3">
    <div class="card-body text-center">
      <div class="row">
        <div class="col-4">
          <h6>Total</h6>
          <b>${total}</b>
        </div>
        <div class="col-4 text-success">
          <h6>Lunas</h6>
          <b>${lunas}</b>
        </div>
        <div class="col-4 text-danger">
          <h6>Belum</h6>
          <b>${belum}</b>
        </div>
      </div>
    </div>
  </div>
  `;

  /* ===== REKAP PETUGAS ===== */
  const map={};
  allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);

  h+=`<table class="table table-bordered">
  <thead class="table-dark">
    <tr><th>Petugas</th><th>Jumlah</th></tr>
  </thead><tbody>`;

  Object.keys(map).forEach(p=>{
    h+=`<tr class="clickable" onclick="openPetugas('${p}')">
    <td>${p}</td><td>${map[p]}</td></tr>`;
  });
  h+=`</tbody></table>`;

  view.innerHTML=h;
}

function openPetugas(p){
  pushView(renderPetugas);
  currentPetugas=p;

  const data=allData.filter(r=>r.petugas===p);
  const lunas=data.filter(isLunas);
  const belum=data.filter(r=>!isLunas(r));

  const byDate={};
  lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

  let h=`<h6 class="text-primary">Petugas: ${p}</h6>

  <h6 class="text-success mt-3">Lunas per Tanggal</h6>
  <table class="table table-sm table-bordered">
  <thead class="table-success">
    <tr><th>Tanggal</th><th>Jumlah</th></tr>
  </thead><tbody>`;

  Object.keys(byDate).forEach(t=>{
    h+=`<tr class="clickable" onclick="detailLunas('${t}')">
    <td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  h+=`</tbody></table>`;

  if(belum.length>0){
    h+=`<h6 class="text-secondary mt-3 clickable" onclick="detailBelum()">
    Belum Lunas
    </h6>`;
  }

  view.innerHTML=h;
}

function detailLunas(t){
  pushView(()=>openPetugas(currentPetugas));
  currentTitle=`Lunas_${t}_${currentPetugas}`;
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && isLunas(r) && r.tgl_lunas===t);
  renderDetailTable(`Detail Lunas ${t}`,"success");
}

function detailBelum(){
  pushView(()=>openPetugas(currentPetugas));
  currentTitle=`Belum_Lunas_${currentPetugas}`;
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && !isLunas(r));
  renderDetailTable("Detail Belum Lunas","secondary");
}

function renderDetailTable(title,color){
  let h=`<div class="d-flex justify-content-between align-items-center">
  <h6 class="text-${color}">${title}</h6>
  <button class="btn btn-success btn-sm" onclick="exportExcel()">⬇ Export Excel</button>
  </div>

  <div class="table-responsive mt-2">
  <table class="table table-sm table-bordered">
  <thead class="table-${color}">
  <tr>
  <th>IDPEL</th><th>Nama</th><th>Alamat</th>
  <th>Koded</th><th>Tarif</th><th>Daya</th><th>Rp</th>
  </tr></thead><tbody>`;

  currentDetail.forEach(r=>{
    h+=`<tr class="clickable" onclick="showCards()">
    <td>${r.idpel}</td>
    <td>${r.nama}</td>
    <td>${r.alamat}</td>
    <td>${r.koked}</td>
    <td>${r.tarif}</td>
    <td>${r.daya}</td>
    <td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td>
    </tr>`;
  });

  h+=`</tbody></table></div>`;
  view.innerHTML=h;
}

function exportExcel(){
  let table=`<table><tr>
  <th>IDPEL</th><th>Nama</th><th>Alamat</th>
  <th>Koded</th><th>Tarif</th><th>Daya</th><th>Jumlah</th>
  </tr>`;
  currentDetail.forEach(r=>{
    table+=`<tr>
    <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
    <td>${r.koked}</td><td>${r.tarif}</td><td>${r.daya}</td>
    <td>${r.jumlah}</td></tr>`;
  });
  table+=`</table>`;
  saveAs(new Blob([table],{type:"application/vnd.ms-excel"}),`${currentTitle}.xls`);
}

function showCards(){
  pushView(()=>renderDetailTable(currentTitle,"secondary"));
  let h=`<h6 class="text-primary">Detail Pelanggan</h6>`;
  currentDetail.forEach(r=>{
    h+=`<div class="card mb-2">
    <div class="card-body p-2">
    <b>${r.nama}</b><br>
    IDPEL: ${r.idpel}<br>
    ${r.alamat}<br>
    Koded: ${r.koked}<br>
    Tarif/Daya: ${r.tarif}/${r.daya}<br>
    <b>Rp ${(+r.jumlah).toLocaleString("id-ID")}</b>
    </div></div>`;
  });
  view.innerHTML=h;
}
</script>
</body>
</html>




