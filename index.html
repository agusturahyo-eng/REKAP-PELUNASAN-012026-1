<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { background:#f4f6f9 }
.header {
  background:#009fe3;
  color:white;
  padding:15px;
  border-radius:10px;
}
.card { border-radius:12px }
.click { cursor:pointer }
</style>
</head>

<body class="container my-3">

<!-- HEADER -->
<div class="header mb-3 text-center">
  <h5 class="mb-0">PT PLN (Persero)</h5>
  <small>ULP TULUNG</small>
  <h6 class="mt-2">Rekap Tunggakan</h6>
</div>

<button id="btnBack" onclick="goBack()" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>

<div id="tableView"></div>
<div id="cardView"></div>

<script>
/* ===================== CONFIG ===================== */
const CSV_URL = "PASTE_URL_CSV_GOOGLE_SHEET_DI_SINI";

/* ===================== STATE ===================== */
let allData = [];
let level = "petugas";
let currentPetugas = null;
let currentTanggal = null;
let currentDetail = [];

/* ===================== LOAD DATA ===================== */
fetch(CSV_URL)
.then(r=>r.text())
.then(t=>{
  const p = Papa.parse(t,{header:true,skipEmptyLines:true});
  allData = p.data;
  renderPetugas();
});

/* ===================== WA STATUS ===================== */
function getWASent(){
  return JSON.parse(localStorage.getItem("wa_sent")||"{}");
}
function isWASent(id){ return getWASent()[id]; }
function markWASent(id){
  const d=getWASent(); d[id]=true;
  localStorage.setItem("wa_sent",JSON.stringify(d));
  renderCardView(currentDetail);
}

/* ===================== WA MESSAGE ===================== */
function waText(r){
return encodeURIComponent(`
PT. PLN (PERSERO)
UP3 KLATEN - ULP TULUNG

PEMBERITAHUAN PEMUTUSAN SEMENTARA

Nama : ${r.nama}
IDPEL : ${r.idpel}
Alamat : ${r.alamat}
Tarif/Daya : ${r.tarif}/${r.daya}
Koked : ${r.koked}

Periode : ${r.periode}
Jumlah Tunggakan :
Rp ${(+r.jumlah).toLocaleString("id-ID")}

Mohon segera melakukan pelunasan.
Abaikan pesan ini jika sudah membayar.

PLN ULP TULUNG
`);
}

/* ===================== RENDER ===================== */
function renderPetugas(){
  level="petugas";
  document.getElementById("btnBack").classList.add("d-none");
  document.getElementById("cardView").innerHTML="";

  const r={};
  allData.forEach(x=>{
    r[x.petugas]=(r[x.petugas]||0)+1;
  });

  let h=`<table class="table table-bordered bg-white">
  <tr class="table-primary"><th>Petugas</th><th>Jumlah</th></tr>`;
  Object.keys(r).forEach(p=>{
    h+=`<tr class="click" onclick="renderTanggal('${p}')">
    <td>${p}</td><td>${r[p]}</td></tr>`;
  });
  h+=`</table>`;
  document.getElementById("tableView").innerHTML=h;
}

function renderTanggal(p){
  level="tanggal"; currentPetugas=p;
  document.getElementById("btnBack").classList.remove("d-none");

  const f=allData.filter(x=>x.petugas===p);
  const r={};
  f.forEach(x=>r[x.tgl_lunas]=(r[x.tgl_lunas]||0)+1);

  let h=`<table class="table table-bordered bg-white">
  <tr class="table-success"><th>Tanggal</th><th>Jumlah</th></tr>`;
  Object.keys(r).forEach(t=>{
    h+=`<tr class="click" onclick="renderDetail('${p}','${t}')">
    <td>${t}</td><td>${r[t]}</td></tr>`;
  });
  h+=`</table>`;
  document.getElementById("tableView").innerHTML=h;
}

function renderDetail(p,t){
  level="detail"; currentTanggal=t;
  document.getElementById("btnBack").classList.remove("d-none");

  const f=allData.filter(x=>x.petugas===p && x.tgl_lunas===t);
  currentDetail=f;

  let h=`<table class="table table-bordered bg-white">
  <tr class="table-dark">
    <th>IDPEL</th><th>Nama</th><th>Jumlah</th>
  </tr>`;
  f.forEach(x=>{
    h+=`<tr class="click" onclick="renderCardView(currentDetail)">
    <td>${x.idpel}</td>
    <td>${x.nama}</td>
    <td>Rp ${(+x.jumlah).toLocaleString("id-ID")}</td>
    </tr>`;
  });
  h+=`</table>`;
  document.getElementById("tableView").innerHTML=h;
  renderCardView(f);
}

/* ===================== CARD VIEW ===================== */
function renderCardView(data){
let h="";
data.forEach(r=>{
const sent=isWASent(r.idpel);
h+=`
<div class="card mb-2 ${sent?'border-success':''}">
<div class="card-body p-2">
${sent?'<span class="badge bg-success mb-1">âœ” SUDAH DIKIRIM</span><br>':''}
<b>${r.nama}</b><br>
IDPEL: ${r.idpel}<br>
${r.alamat}<br>
Koked: ${r.koked}<br>
Tarif/Daya: ${r.tarif}/${r.daya}<br>
<b>Rp ${(+r.jumlah).toLocaleString("id-ID")}</b>
<div class="mt-2">
<a target="_blank"
 class="btn btn-success btn-sm"
 href="https://wa.me/${r.no_hp}?text=${waText(r)}">
ðŸ“¤ WhatsApp
</a>
<button class="btn btn-outline-success btn-sm"
 onclick="markWASent('${r.idpel}')">
âœ” Tandai
</button>
</div>
</div>
</div>`;
});
document.getElementById("cardView").innerHTML=h;
}

/* ===================== BACK ===================== */
function goBack(){
if(level==="detail") renderTanggal(currentPetugas);
else renderPetugas();
}
</script>

</body>
</html>

