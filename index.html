<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Tunggakan ULP Tulung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { background:#f5f7fa; }
    .clickable { cursor:pointer; }
    .clickable:hover { background:#eef2f7; }
  </style>
</head>

<body>
<div class="container my-3">

  <h4 class="text-center text-primary mb-3">
    üìä Rekap Tunggakan ULP Tulung
  </h4>

  <button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none" onclick="goBack()">‚¨Ö Kembali</button>

  <div id="tableArea"></div>

</div>

<script>
/* ================= CONFIG ================= */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?output=csv";

/* ================= STATE ================= */
let allData = [];
let currentLevel = "petugas";
let currentPetugas = null;

/* ================= HELPER ================= */
function isLunas(r) {
  return (
    r.tgl_lunas &&
    r.tgl_lunas.toString().trim() !== "" &&
    r.tgl_lunas.toString().toUpperCase() !== "BELUM" &&
    r.tgl_lunas !== "-"
  );
}

/* ================= LOAD ================= */
fetch(SHEET_URL)
  .then(res => res.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
    allData = parsed.data;
    renderRekapPetugas();
  });

/* ================= VIEW ================= */
function renderRekapPetugas() {
  currentLevel = "petugas";
  document.getElementById("backBtn").classList.add("d-none");

  const rekap = {};
  allData.forEach(r => {
    if (!rekap[r.petugas]) rekap[r.petugas] = 0;
    rekap[r.petugas]++;
  });

  let html = `
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr><th>Petugas</th><th>Jumlah Data</th></tr>
      </thead><tbody>`;

  Object.keys(rekap).forEach(p => {
    html += `
      <tr class="clickable" onclick="renderPetugasDetail('${p}')">
        <td>${p}</td>
        <td>${rekap[p]}</td>
      </tr>`;
  });

  html += "</tbody></table>";
  document.getElementById("tableArea").innerHTML = html;
}

function renderPetugasDetail(petugas) {
  currentLevel = "detailPetugas";
  currentPetugas = petugas;
  document.getElementById("backBtn").classList.remove("d-none");

  const dataPetugas = allData.filter(r => r.petugas === petugas);
  const lunas = dataPetugas.filter(isLunas);
  const belum = dataPetugas.filter(r => !isLunas(r));

  let html = `<h6 class="text-primary">Petugas: ${petugas}</h6>`;

  /* ===== LUNAS PER TANGGAL ===== */
  const rekapLunas = {};
  lunas.forEach(r => {
    if (!rekapLunas[r.tgl_lunas]) rekapLunas[r.tgl_lunas] = 0;
    rekapLunas[r.tgl_lunas]++;
  });

  html += `
    <h6 class="text-success mt-3">‚úÖ Lunas per Tanggal</h6>
    <table class="table table-sm table-bordered">
      <thead class="table-success">
        <tr><th>Tanggal</th><th>Jumlah</th></tr>
      </thead><tbody>`;

  Object.keys(rekapLunas).forEach(tgl => {
    html += `
      <tr class="clickable" onclick="renderDetailLunas('${tgl}')">
        <td>${tgl}</td>
        <td>${rekapLunas[tgl]}</td>
      </tr>`;
  });

  html += "</tbody></table>";

  /* ===== BELUM LUNAS ===== */
  const totalBelum = belum.reduce((a,b)=>a+Number(b.jumlah||0),0);

  html += `
    <h6 class="text-danger mt-3">‚ùå Belum Lunas</h6>
    <table class="table table-sm table-bordered clickable"
           onclick="renderDetailBelumLunas()">
      <thead class="table-danger">
        <tr><th>Jumlah Pelanggan</th><th>Total Rp</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>${belum.length}</td>
          <td>${totalBelum.toLocaleString("id-ID")}</td>
        </tr>
      </tbody>
    </table>`;

  document.getElementById("tableArea").innerHTML = html;
}

function renderDetailLunas(tanggal) {
  currentLevel = "detailLunas";

  const data = allData.filter(r =>
    r.petugas === currentPetugas &&
    isLunas(r) &&
    r.tgl_lunas === tanggal
  );

  let html = `
    <h6 class="text-success">Detail Lunas - ${tanggal}</h6>
    <div class="table-responsive">
    <table class="table table-sm table-striped table-bordered">
      <thead class="table-success">
        <tr>
          <th>IDPEL</th>
          <th>Nama</th>
          <th>Alamat</th>
          <th>Koded</th>
          <th>Tarif/Daya</th>
          <th>Rp</th>
        </tr>
      </thead><tbody>`;

  data.forEach(r => {
    html += `
      <tr>
        <td>${r.idpel}</td>
        <td>${r.nama}</td>
        <td>${r.alamat}</td>
        <td>${r.koked}</td>
        <td>${r.tarif} / ${r.daya}</td>
        <td class="text-end">${Number(r.jumlah).toLocaleString("id-ID")}</td>
      </tr>`;
  });

  html += "</tbody></table></div>";
  document.getElementById("tableArea").innerHTML = html;
}

function renderDetailBelumLunas() {
  currentLevel = "detailBelum";

  const data = allData.filter(r =>
    r.petugas === currentPetugas && !isLunas(r)
  );

  let html = `
    <h6 class="text-danger">Detail Belum Lunas</h6>
    <div class="table-responsive">
    <table class="table table-sm table-striped table-bordered">
      <thead class="table-danger">
        <tr>
          <th>IDPEL</th>
          <th>Nama</th>
          <th>Alamat</th>
          <th>Koded</th>
          <th>Tarif/Daya</th>
          <th>Rp</th>
        </tr>
      </thead><tbody>`;

  data.forEach(r => {
    html += `
      <tr>
        <td>${r.idpel}</td>
        <td>${r.nama}</td>
        <td>${r.alamat}</td>
        <td>${r.koked}</td>
        <td>${r.tarif} / ${r.daya}</td>
        <td class="text-end">${Number(r.jumlah).toLocaleString("id-ID")}</td>
      </tr>`;
  });

  html += "</tbody></table></div>";
  document.getElementById("tableArea").innerHTML = html;
}

function goBack() {
  if (currentLevel === "detailLunas" || currentLevel === "detailBelum") {
    renderPetugasDetail(currentPetugas);
  } else {
    renderRekapPetugas();
  }
}
</script>
</body>
</html>




