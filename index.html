<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">⚡ Rekap Tunggakan ULP Tulung</h4>
<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none" onclick="goBack()">⬅ Kembali</button>
<div id="view"></div>

</div>

<script>
/* ========= CONFIG ========= */
const SHEETS={
  lembar1:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

/* ========= STATE ========= */
let allData=[];
let currentPetugas=null;
let currentTanggal=null;
let currentDetail=[];
let currentView="PETUGAS"; // PETUGAS | REKAP | DETAIL | CARD

const isLunas=r=>r.tgl_lunas && r.tgl_lunas!="-";

/* ========= LOAD ========= */
function loadSheet(k){
  fetch(SHEETS[k].url).then(r=>r.text()).then(csv=>{
    allData=Papa.parse(csv,{header:true}).data;
    renderPetugas();
  });
}

/* ========= BACK ========= */
function goBack(){
  if(currentView==="CARD") renderDetail();
  else if(currentView==="DETAIL") renderRekapTanggal();
  else if(currentView==="REKAP") renderPetugas();
}

/* ========= PETUGAS ========= */
function renderPetugas(){
  currentView="PETUGAS";
  backBtn.classList.add("d-none");

  const map={};
  allData.forEach(r=>map[r.petugas]=(map[r.petugas]||0)+1);

  let h=`<table class="table table-bordered"><thead class="table-dark">
  <tr><th>Petugas</th><th>Jumlah</th></tr></thead><tbody>`;
  Object.keys(map).forEach(p=>{
    h+=`<tr class="clickable" onclick="openPetugas('${p}')">
    <td>${p}</td><td>${map[p]}</td></tr>`;
  });
  h+=`</tbody></table>`;
  view.innerHTML=h;
}

/* ========= REKAP ========= */
function openPetugas(p){
  currentPetugas=p;
  currentView="REKAP";
  backBtn.classList.remove("d-none");

  const lunas=allData.filter(r=>r.petugas===p && isLunas(r));
  const byDate={};
  lunas.forEach(r=>byDate[r.tgl_lunas]=(byDate[r.tgl_lunas]||0)+1);

  let h=`<h6>Petugas: ${p}</h6>
  <table class="table table-sm table-bordered">
  <tr><th>Tanggal</th><th>Jumlah</th></tr>`;
  Object.keys(byDate).forEach(t=>{
    h+=`<tr class="clickable" onclick="openDetail('${t}')">
    <td>${t}</td><td>${byDate[t]}</td></tr>`;
  });
  h+=`</table>`;
  view.innerHTML=h;
}

function renderRekapTanggal(){
  openPetugas(currentPetugas);
}

/* ========= DETAIL ========= */
function openDetail(t){
  currentTanggal=t;
  currentView="DETAIL";
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && r.tgl_lunas===t);
  renderDetail();
}

function renderDetail(){
  currentView="DETAIL";
  let h=`<h6>Detail ${currentTanggal}</h6>
  <table class="table table-sm table-bordered">
  <tr><th>IDPEL</th><th>Nama</th><th>Rp</th></tr>`;
  currentDetail.forEach(r=>{
    h+=`<tr class="clickable" onclick="showCards()">
    <td>${r.idpel}</td><td>${r.nama}</td>
    <td>${(+r.jumlah).toLocaleString("id-ID")}</td></tr>`;
  });
  h+=`</table>`;
  view.innerHTML=h;
}

/* ========= CARD ========= */
function showCards(){
  currentView="CARD";
  let h=`<h6>Detail Pelanggan</h6>`;
  currentDetail.forEach(r=>{
    h+=`<div class="card mb-2"><div class="card-body p-2">
    <b>${r.nama}</b><br>IDPEL: ${r.idpel}<br>
    Rp ${(+r.jumlah).toLocaleString("id-ID")}
    </div></div>`;
  });
  view.innerHTML=h;
}

/* ========= INIT ========= */
loadSheet("lembar1");
</script>
</body>
</html>







